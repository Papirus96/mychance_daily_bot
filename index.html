
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP) ‚Äî –®–ê–ù–°</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#ffcc66;color:#7a2e14;margin:0;padding:20px}
    h1{margin:0 0 12px;text-align:center;color:#a64214}
    table{width:100%;border-collapse:collapse;background:#fff8e1}
    th,td{border:1px solid #e0a958;padding:10px;text-align:left;vertical-align:top}
    th{background:#ffd27f}
    a{color:#a64214;text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:#9a7b60}
  </style>
</head>
<body>
  <h1>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP)</h1>
  <table id="tbl">
    <thead>
      <tr>
        <th>–ö–∞–Ω–∞–ª</th>
        <th>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à</th>
        <th>–ü—Ä–∏–∑—ã</th>
        <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
        <th>–£—Å–ª–æ–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" style="text-align:center;margin-top:14px">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: Google –¢–∞–±–ª–∏—Ü–∞ ¬´–ö–æ–Ω–∫—É—Ä—Å—ã –®–ê–ù–°¬ª. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.</p>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    const SHEET_ID   = "1ywWbGtsvKfrYdxFsekvXL7EKmd30_xxZQB0E8XqUU8U";
    const SHEET_NAME = "–ö–æ–Ω–∫—É—Ä—Å—ã –®–ê–ù–°"; // –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
    // –ë–µ—Ä—ë–º A:G, —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ A..E (F,G = —Ç–µ—Ö. –∫–æ–ª–æ–Ω–∫–∏)
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A:G`;

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ–≥—Ä–∞–º-—Å—Å—ã–ª–æ–∫: "@name", "t.me/name", "https://t.me/name", "telegram.me/name"
    function normalizeTelegramLink(raw) {
      if (!raw) return null;
      let s = String(raw).trim();
      if (!s) return null;
      if (s.startsWith("@")) s = "https://t.me/" + s.slice(1);
      if (s.startsWith("t.me/")) s = "https://" + s;
      if (s.startsWith("telegram.me/")) s = "https://" + s;
      if (!/^https?:\/\//i.test(s) && /^[A-Za-z0-9_]+$/.test(s)) s = "https://t.me/" + s;
      if (/^https?:\/\//i.test(s)) return s;
      return null;
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
    function parseSheetDate(val) {
      if (!val) return null;
      const str = String(val);
      // GViz —Ñ–æ—Ä–º–∞—Ç: Date(YYYY,MM,DD)
      let m = str.match(/Date\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (m) return new Date(+m[1], +m[2], +m[3]);
      // DD.MM.YYYY / DD-MM-YYYY
      m = str.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
      if (m) return new Date((m[3].length===2?('20'+m[3]):m[3]), +m[2]-1, +m[1]);
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }

    function formatDate(val){
      const d = parseSheetDate(val);
      if (!d) return val || "";
      return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"});
    }

    function onlyActive(endRaw, filterRaw){
      const today = new Date(); today.setHours(0,0,0,0);
      const df = parseSheetDate(filterRaw) || parseSheetDate(endRaw);
      if (!df) return true; // –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã ‚Äî –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
      return df >= today;
    }

    // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ <a>
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç http(s), t.me/..., @username
    function linkify(text) {
      if (!text) return "";
      let t = String(text);

      // –°–Ω–∞—á–∞–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã
      t = t.replace(/\r\n|\r/g, "\n");

      // http(s) —Å—Å—ã–ª–∫–∏
      t = t.replace(/((https?:\/\/)[^\s<]+)/gi, (m) => {
        return `<a href="${m}" target="_blank">${m}</a>`;
      });

      // t.me/ –∏–ª–∏ telegram.me/
      t = t.replace(/(?:^|\s)(?:https?:\/\/)?(?:t\.me|telegram\.me)\/([A-Za-z0-9_\/]+)/gi, (m, p1) => {
        const url = `https://t.me/${p1}`;
        return ` <a href="${url}" target="_blank">${url}</a>`;
      });

      // @username (–Ω–µ –≤–Ω—É—Ç—Ä–∏ —Å—Å—ã–ª–æ–∫)
      t = t.replace(/(^|\s)@([A-Za-z0-9_]+)/g, (m, sp, u) => {
        const url = `https://t.me/${u}`;
        return `${sp}<a href="${url}" target="_blank">@${u}</a>`;
      });

      // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ -> <br>
      t = t.replace(/\n/g, "<br>");
      return t;
    }

    fetch(URL)
      .then(r => r.text())
      .then(txt => {
        const json = JSON.parse(txt.substr(47).slice(0, -2));
        const rows = json.table.rows || [];
        const tbody = document.querySelector("#tbl tbody");

        rows.forEach(row => {
          const cells = (row.c || []).map(c => (c && (c.v!==undefined ? c.v : c.f)) || "");

          // –ò–Ω–¥–µ–∫—Å—ã: A=0 –∫–∞–Ω–∞–ª, B=1 –ø–æ—Å—Ç, C=2 –ø—Ä–∏–∑—ã, D=3 –¥–∞—Ç–∞, E=4 —É—Å–ª–æ–≤–∏—è, F=5 –¥–∞—Ç–∞_—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, G=6 –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
          if (!onlyActive(cells[3], cells[5])) return;

          const tr = document.createElement("tr");

          // –ö–∞–Ω–∞–ª
          const channelTd = document.createElement("td");
          const chUrl = normalizeTelegramLink(cells[0]);
          if (chUrl){
            const a = document.createElement("a");
            a.href = chUrl; a.target="_blank";
            a.textContent = chUrl.replace(/^https?:\/\/(t\.me|telegram\.me)\//i,"");
            channelTd.appendChild(a);
          } else {
            channelTd.textContent = cells[0] || "-";
          }
          tr.appendChild(channelTd);

          // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à
          const postTd = document.createElement("td");
          const postUrl = normalizeTelegramLink(cells[1]) || (cells[1] && /^https?:\/\//i.test(cells[1]) ? cells[1] : null);
          if (postUrl){
            const a = document.createElement("a");
            a.href = postUrl; a.target="_blank"; a.textContent = "–û—Ç–∫—Ä—ã—Ç—å";
            postTd.appendChild(a);
          } else {
            postTd.textContent = cells[1] || "-";
          }
          tr.appendChild(postTd);

          // –ü—Ä–∏–∑—ã
          const prizesTd = document.createElement("td");
          prizesTd.innerHTML = linkify(cells[2] || "");
          tr.appendChild(prizesTd);

          // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
          const dateTd = document.createElement("td");
          dateTd.textContent = formatDate(cells[3]);
          tr.appendChild(dateTd);

          // –£—Å–ª–æ–≤–∏—è (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å—é —Å—Å—ã–ª–æ–∫ –∏ @)
          const condTd = document.createElement("td");
          condTd.innerHTML = linkify(cells[4] || "");
          tr.appendChild(condTd);

          tbody.appendChild(tr);
        });

        if (!tbody.children.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5; td.textContent = "–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤.";
          tr.appendChild(td); tbody.appendChild(tr);
        }
      })
      .catch(err => {
        console.error(err);
        const tbody = document.querySelector("#tbl tbody");
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5; td.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        tr.appendChild(td); tbody.appendChild(tr);
      });
  </script>
</body>
</html>
