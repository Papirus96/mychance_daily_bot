
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP) ‚Äî –®–ê–ù–°</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#ffcc66;color:#7a2e14;margin:0;padding:20px}
    h1{margin:0 0 12px;text-align:center;color:#a64214}
    table{width:100%;border-collapse:collapse;background:#fff8e1}
    th,td{border:1px solid #e0a958;padding:10px;text-align:left;vertical-align:top}
    th{background:#ffd27f}
    a{color:#a64214;text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:#9a7b60}
  </style>
</head>
<body>
  <h1>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP)</h1>
  <table id="tbl">
    <thead>
      <tr>
        <th>–ö–∞–Ω–∞–ª</th>
        <th>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à</th>
        <th>–ü—Ä–∏–∑—ã</th>
        <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
        <th>–£—Å–ª–æ–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p class="muted" style="text-align:center;margin-top:14px">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: Google –¢–∞–±–ª–∏—Ü–∞ ¬´–ö–æ–Ω–∫—É—Ä—Å—ã –®–ê–ù–°¬ª. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è.</p>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    const SHEET_ID   = "1ywWbGtsvKfrYdxFsekvXL7EKmd30_xxZQB0E8XqUU8U";
    const SHEET_NAME = "–ö–æ–Ω–∫—É—Ä—Å—ã –®–ê–ù–°"; // –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
    // –ë–µ—Ä—ë–º –í–°–ï —Å—Ç–æ–ª–±—Ü—ã, –Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ A..E (—Ç–µ—Ö. F,G –ø—Ä—è—á–µ–º)
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A:G`;

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫ –≤–∏–¥–∞ "@name", "t.me/name", "https://t.me/name"
    function normalizeTelegramLink(raw) {
      if (!raw) return null;
      let s = String(raw).trim();
      if (!s) return null;
      if (s.startsWith("@")) s = "https://t.me/" + s.slice(1);
      if (s.startsWith("t.me/")) s = "https://" + s;
      if (s.startsWith("telegram.me/")) s = "https://" + s;
      if (!/^https?:\/\//i.test(s) && /^[A-Za-z0-9_]+$/.test(s)) s = "https://t.me/" + s;
      if (/^https?:\/\//i.test(s)) return s;
      return null;
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
    function parseSheetDate(val) {
      if (!val) return null;
      // –ü—Ä–∏–ª–µ—Ç–∞–µ—Ç –≤ –≤–∏–¥–µ "Date(2025,8,7)" –∏–ª–∏ "7.09.2025" –∏–ª–∏ ISO
      const str = String(val);
      let m = str.match(/Date\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (m) return new Date(+m[1], +m[2], +m[3]);
      m = str.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
      if (m) return new Date(+m[3].padStart(4,"20"), +m[2]-1, +m[1]);
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }

    function formatDate(val){
      const d = parseSheetDate(val);
      if (!d) return val || "";
      return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"});
    }

    function onlyActive(endRaw, filterRaw){
      const today = new Date(); today.setHours(0,0,0,0);
      const df = parseSheetDate(filterRaw) || parseSheetDate(endRaw);
      if (!df) return true; // –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–Ω–∞ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ)
      return df >= today;
    }

    fetch(URL)
      .then(r => r.text())
      .then(txt => {
        // gviz-–æ—Ç–≤–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "google.visualization.Query.setResponse(...);"
        const json = JSON.parse(txt.substr(47).slice(0, -2));
        const rows = json.table.rows || [];
        const tbody = document.querySelector("#tbl tbody");

        rows.forEach(row => {
          const cells = (row.c || []).map(c => (c && (c.v!==undefined ? c.v : c.f)) || "");

          // –ò–Ω–¥–µ–∫—Å—ã: A=0 –∫–∞–Ω–∞–ª, B=1 —Å—Å—ã–ª–∫–∞, C=2 –ø—Ä–∏–∑—ã, D=3 –¥–∞—Ç–∞, E=4 —É—Å–ª–æ–≤–∏—è, F=5 –¥–∞—Ç–∞_—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, G=6 –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
          if (!onlyActive(cells[3], cells[5])) return; // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏

          const tr = document.createElement("tr");

          // –ö–∞–Ω–∞–ª (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ –ø—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–π —Å—Å—ã–ª–∫–µ)
          const channelTd = document.createElement("td");
          const chUrl = normalizeTelegramLink(cells[0]);
          if (chUrl){
            const a = document.createElement("a");
            a.href = chUrl; a.target="_blank";
            a.textContent = chUrl.replace(/^https?:\/\/(t\.me|telegram\.me)\//i,"");
            channelTd.appendChild(a);
          } else {
            channelTd.textContent = cells[0] || "-";
          }
          tr.appendChild(channelTd);

          // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à (–¥–µ–ª–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π –ø–æ —Ç–µ–º –∂–µ –ø—Ä–∞–≤–∏–ª–∞–º)
          const postTd = document.createElement("td");
          const postUrl = normalizeTelegramLink(cells[1]) || (cells[1] && cells[1].startsWith("http") ? cells[1] : null);
          if (postUrl){
            const a = document.createElement("a");
            a.href = postUrl; a.target="_blank"; a.textContent = "–û—Ç–∫—Ä—ã—Ç—å";
            postTd.appendChild(a);
          } else {
            postTd.textContent = cells[1] || "-";
          }
          tr.appendChild(postTd);

          // –ü—Ä–∏–∑—ã (–ø–µ—Ä–µ–≤–æ–¥–∏–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ <br>)
          const prizesTd = document.createElement("td");
          prizesTd.innerHTML = String(cells[2] || "").replace(/\n/g,"<br>");
          tr.appendChild(prizesTd);

          // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
          const dateTd = document.createElement("td");
          dateTd.textContent = formatDate(cells[3]);
          tr.appendChild(dateTd);

          // –£—Å–ª–æ–≤–∏—è
          const condTd = document.createElement("td");
          condTd.innerHTML = String(cells[4] || "").replace(/\n/g,"<br>");
          tr.appendChild(condTd);

          tbody.appendChild(tr);
        });

        if (!tbody.children.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5; td.textContent = "–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤.";
          tr.appendChild(td); tbody.appendChild(tr);
        }
      })
      .catch(err => {
        console.error(err);
        const tbody = document.querySelector("#tbl tbody");
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5; td.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        tr.appendChild(td); tbody.appendChild(tr);
      });
  </script>
</body>
</html>
