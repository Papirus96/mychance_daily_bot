
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP) ‚Äî –®–ê–ù–°</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#ffcc66;color:#7a2e14;margin:0;padding:20px}
    h1{margin:0 0 12px;text-align:center;color:#a64214}
    table{width:100%;border-collapse:collapse;background:#fff8e1}
    th,td{border:1px solid #e0a958;padding:10px;text-align:left;vertical-align:top}
    th{background:#ffd27f}
    a{color:#a64214;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <h1>üéÅ –í—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã (VIP)</h1>
  <table id="tbl">
    <thead>
      <tr>
        <th>–ö–∞–Ω–∞–ª</th>
        <th>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–æ–∑—ã–≥—Ä—ã—à</th>
        <th>–ü—Ä–∏–∑—ã</th>
        <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
        <th>–£—Å–ª–æ–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SHEET_ID   = "1ywWbGtsvKfrYdxFsekvXL7EKmd30_xxZQB0E8XqUU8U";
    const SHEET_NAME = "–ö–æ–Ω–∫—É—Ä—Å—ã –®–ê–ù–°";
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A:G`;

    function normalizeTelegramLink(raw) {
      if (!raw) return null;
      let s = String(raw).trim();
      if (!s) return null;
      if (s.startsWith("@")) s = "https://t.me/" + s.slice(1);
      if (s.startsWith("t.me/")) s = "https://" + s;
      if (s.startsWith("telegram.me/")) s = "https://" + s;
      if (!/^https?:\/\//i.test(s) && /^[A-Za-z0-9_]+$/.test(s)) s = "https://t.me/" + s;
      if (/^https?:\/\//i.test(s)) return s;
      return null;
    }

    function parseSheetDate(val) {
      if (!val) return null;
      const str = String(val);
      let m = str.match(/Date\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (m) return new Date(+m[1], +m[2], +m[3]);
      m = str.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
      if (m) return new Date((m[3].length===2?('20'+m[3]):m[3]), +m[2]-1, +m[1]);
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }

    function formatDate(val){
      const d = parseSheetDate(val);
      if (!d) return val || "";
      return d.toLocaleDateString("ru-RU",{day:"2-digit",month:"long",year:"numeric"});
    }

    function onlyActive(endRaw, filterRaw){
      const today = new Date(); today.setHours(0,0,0,0);
      const df = parseSheetDate(filterRaw) || parseSheetDate(endRaw);
      if (!df) return true;
      return df >= today;
    }

    function linkify(text) {
      if (!text) return "";
      let t = String(text);
      t = t.replace(/\r\n|\r/g, "\n");
      t = t.replace(/((https?:\/\/)[^\s<]+)/gi, (m) => `<a href="${m}" target="_blank">${m}</a>`);
      t = t.replace(/(?:^|\s)(?:https?:\/\/)?(?:t\.me|telegram\.me)\/([A-Za-z0-9_\/]+)/gi, (m, p1) => {
        const url = `https://t.me/${p1}`;
        return ` <a href="${url}" target="_blank">${url}</a>`;
      });
      t = t.replace(/(^|\s)@([A-Za-z0-9_]+)/g, (m, sp, u) => {
        const url = `https://t.me/${u}`;
        return `${sp}<a href="${url}" target="_blank">@${u}</a>`;
      });
      t = t.replace(/\n/g, "<br>");
      return t;
    }

    fetch(URL)
      .then(r => r.text())
      .then(txt => {
        const json = JSON.parse(txt.substr(47).slice(0, -2));
        const rows = json.table.rows || [];
        const tbody = document.querySelector("#tbl tbody");

        rows.forEach(row => {
          const cells = (row.c || []).map(c => (c && (c.v!==undefined ? c.v : c.f)) || "");

          if (!onlyActive(cells[3], cells[5])) return;

          const tr = document.createElement("tr");

          const channelTd = document.createElement("td");
          const chUrl = normalizeTelegramLink(cells[0]);
          if (chUrl){
            const a = document.createElement("a");
            a.href = chUrl; a.target="_blank";
            a.textContent = chUrl.replace(/^https?:\/\/(t\.me|telegram\.me)\//i,"");
            channelTd.appendChild(a);
          } else {
            channelTd.textContent = cells[0] || "-";
          }
          tr.appendChild(channelTd);

          const postTd = document.createElement("td");
          const postUrl = normalizeTelegramLink(cells[1]) || (cells[1] && /^https?:\/\//i.test(cells[1]) ? cells[1] : null);
          if (postUrl){
            const a = document.createElement("a");
            a.href = postUrl; a.target="_blank"; a.textContent = "–û—Ç–∫—Ä—ã—Ç—å";
            postTd.appendChild(a);
          } else {
            postTd.textContent = cells[1] || "-";
          }
          tr.appendChild(postTd);

          const prizesTd = document.createElement("td");
          prizesTd.innerHTML = linkify(cells[2] || "");
          tr.appendChild(prizesTd);

          const dateTd = document.createElement("td");
          dateTd.textContent = formatDate(cells[3]);
          tr.appendChild(dateTd);

          const condTd = document.createElement("td");
          condTd.innerHTML = linkify(cells[4] || "");
          tr.appendChild(condTd);

          tbody.appendChild(tr);
        });

        if (!tbody.children.length){
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5; td.textContent = "–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤.";
          tr.appendChild(td); tbody.appendChild(tr);
        }
      })
      .catch(err => {
        console.error(err);
        const tbody = document.querySelector("#tbl tbody");
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5; td.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        tr.appendChild(td); tbody.appendChild(tr);
      });
  </script>
</body>
</html>
